name: cd

on:
  pull_request:
    branches: [ master ]
  workflow_dispatch:

jobs:
  cd:
    name: OpenCOR's user documentation
    if: ${{ github.head_ref == 'new-snapshot' }}
    runs-on: ubuntu-latest
    steps:
      - name: Check commit message
        run: echo ">>> github.event.head_commit.message: >${{ github.event.head_commit.message }}<"
      - name: Install CMake and Ninja
        uses: lukka/get-cmake@latest
      - name: Install packages
        run: sudo apt install python3-sphinx
      - name: Retrieve OpenCOR's user documentation
        uses: actions/checkout@v2
        with:
          repository: opencor/user-documentation
          path: user-documentation
      - name: Build OpenCOR's user documentation
        run: |
          cd user-documentation
          ./opencor
      - name: Retrieve OpenCOR's GitHub Pages
        uses: actions/checkout@v2
        with:
          repository: opencor/opencor.github.io
          path: opencor.github.io
      - name: Update OpenCOR's GitHub Pages
        run: |
          cd opencor.github.io
          git rm -fr *
          touch .nojekyll
          cp -fr ../user-documentation/build/html/* .
          git add -A
      - name: Publish OpenCOR's GitHub Pages
        env:
          PERSONAL_ACCESS_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        run: |
          cd opencor.github.io
          echo "---------------------------------------"
          cat .git/config
          echo "---------------------------------------"
          # git config --remove-section "http.https://github.com/"
          # git remote set-url origin git@github.com:opencor/opencor.github.io.git
          # git push --set-upstream origin master
          # git config remote.origin.url "https://github.com/opencor/opencor.github.io.git"
          # git config user.email "$GITHUB_ACTOR@users.noreply.github.com"
          # git config user.name "$GITHUB_ACTOR"
          git config user.name "Alan Garny"
          git config user.email "agarny@hellix.com"
          echo "---------------------------------------"
          cat .git/config
          echo "---------------------------------------"
          git commit -m "OpenCOR's user documentation"
          echo ">>> secrets.GITHUB_TOKEN:          >${{ secrets.GITHUB_TOKEN }}<"
          echo ">>> secrets.PERSONAL_ACCESS_TOKEN: >${{ secrets.PERSONAL_ACCESS_TOKEN }}<"
          echo ">>> PERSONAL_ACCESS_TOKEN:         >$PERSONAL_ACCESS_TOKEN<"
          git push https://${{ secrets.PERSONAL_ACCESS_TOKEN }}@github.com/opencor/opencor.github.io.git
          # git push -f https://${{ secrets.PERSONAL_ACCESS_TOKEN }}@github.com/opencor/opencor.github.io.git
          # git push -f git@github.com:opencor/opencor.github.io.git master:gh-pages
      - name: Push changes
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          branch: ${{ github.head_ref }}
      # - name: Check things
      #   run: |
      #     pwd
      #     ls -alR user-documentation
      # - shell: bash
      #   run: |
      #     cd opencor.github.io
      #     git rm -fr *
      #     touch .nojekyll
      #     cp -fr ../user-documentation/build/html/* .
      #     # git branch -f gh-pages HEAD
      #     # git checkout gh-pages
      #     # date > ./user-documentation/build/html/publish_date.txt
      #     git config user.name "Github Pages Overwriter"
      #     git config user.email "GithubPagesOverwriter@users.noreply.github.com"
      #     git add -A
      #     git commit -m "Automated publish"
      #     pwd
      #     # git push -f origin `git subtree split -P /home/runner/work/opencor/opencor/opencor.github.io`:refs/heads/gh-pages
      #     git push -f
      # - name: Update OpenCOR's GitHub Pages
      #   uses: rayluo/github-pages-overwriter@v1.2
      #   with:
      #     source-directory: ./user-documentation/build/html
