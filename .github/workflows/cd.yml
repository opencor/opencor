name: cd

on:
  pull_request:
    branches: [ master ]
  workflow_dispatch:

jobs:
  cd:
    name: Generate and deploy OpenCOR's user documentation
    if: ${{ github.head_ref == 'new-snapshot' }}
    runs-on: ubuntu-latest
    steps:
      - name: Install CMake and Ninja
        uses: lukka/get-cmake@latest
      - name: Install packages
        run: sudo apt install python3-sphinx
      - name: Retrieve OpenCOR's user documentation
        # run: git clone --depth 1 https://github.com/opencor/user-documentation
        run: git clone https://github.com/opencor/user-documentation
      - name: Build OpenCOR's user documentation
        run: |
          cd user-documentation
          ./opencor
      # - name: Retrieve OpenCOR's GitHub Pages
      #   run: git clone --depth 1 https://github.com/opencor/opencor.github.io.git
      # - name: Update OpenCOR's GitHub Pages
      #   run: |
      #     cd opencor.github.io
      #     git rm -fr *
      #     touch .nojekyll
      #     cp -fr ../user-documentation/build/html/* .
      #     git add -A
      #     git config user.name "Alan Garny"
      #     git config user.email "agarny@hellix.com"
      #     git commit -m "OpenCOR's user documentation"
      #     git push -f
      - name: Check things
        run: |
          pwd
          ls -alR user-documentation
      - shell: bash
        run: |
          # The following 2 lines are not really necessary,
          # because we do not intend to push current branch.
          # But we choose to use target branch name as a temporary local work branch,
          # thus avoid a potential error of committing to the trigger branch.
          git branch -f gh-pages HEAD
          git checkout gh-pages
          # Generate such a new file to make sure the subsequent commit would succeed
          # Such a file WITHOUT leading dot (.) is also visible in outcome website.
          # FYI: filename with leading dot (.) or underscore (_) would be ignored by Jekyll,
          # which Github Pages depends on. So we use a normal filename here.
          date > ./user-documentation/build/html/publish_date.txt
          # The commit and push happen to work without authentication
          # https://docs.github.com/en/actions/reference/authentication-in-a-workflow
          git config user.name "Github Pages Overwriter"
          git config user.email "GithubPagesOverwriter@users.noreply.github.com"
          git add -A
          git commit -m "Automated publish"
      - name: Push the build output to github pages
        shell: bash
        run: git push -f origin `git subtree split -P ./user-documentation/build/html`:refs/heads/gh-pages
      # - name: Update OpenCOR's GitHub Pages
      #   uses: rayluo/github-pages-overwriter@v1.2
      #   with:
      #     source-directory: ./user-documentation/build/html
