<!DOCTYPE HTML>
<HTML>
    <HEAD>
        <TITLE>
            Best practices
        </TITLE>

        <META HTTP-EQUIV = "Content-Type" CONTENT = "Text/HTML; Charset=ISO-8859-1">

        <LINK HREF = "../res/stylesheet.css" REL = "Stylesheet" TYPE = "Text/CSS">
        <LINK HREF = "../res/developerStylesheet.css" REL = "Stylesheet" TYPE = "Text/CSS">
    </HEAD>
    <BODY>
        <P CLASS = "TitleBackground">
            <SPAN CLASS = "TitleFont">Best practices</SPAN>
        </P>

        <P>
            <SPAN CLASS = "SectionFont">File Structure</SPAN>
        </P>

        <P>
            Source code files are, in OpenCOR, organised within a very specific <A HREF = "http://opencor.git.sourceforge.net/git/gitweb.cgi?p=opencor/opencor;a=tree">file structure</A>, as shown below. Any new (set of) file(s) is therefore expected to be added to the right folder.
                <PRE><A HREF = "http://opencor.git.sourceforge.net/git/gitweb.cgi?p=opencor/opencor;a=tree;f=3rdparty;h=1a5e4b1f83ae8baa7413ab1fd01f987021b59579;hb=HEAD">3rdparty</A>                    <SPAN CLASS = "Italic">// Various <A HREF = "thirdPartyLibraries.html">third-party libraries</A> used by OpenCOR</SPAN>
    <A HREF = "http://opencor.git.sourceforge.net/git/gitweb.cgi?p=opencor/opencor;a=tree;f=3rdparty/LibQxt;h=f47589e9783147b30b53b358df49a43617190a13;hb=HEAD">LibQxt</A>                      <SPAN CLASS = "Italic">// The <A HREF = "http://libqxt.org/">LibQxt</A> library</A></SPAN>
    <A HREF = "http://opencor.git.sourceforge.net/git/gitweb.cgi?p=opencor/opencor;a=tree;f=3rdparty/QScintilla;h=804e286d198d20e5b9c95232d8e48e31b5bd2616;hb=HEAD">QScintilla</A>                  <SPAN CLASS = "Italic">// The <A HREF = "http://www.riverbankcomputing.co.uk/software/qscintilla/">QScintilla</A> library</SPAN>
    <A HREF = "http://opencor.git.sourceforge.net/git/gitweb.cgi?p=opencor/opencor;a=tree;f=3rdparty/QtSingleApplication;h=ac6f50ca5aeec552afe6afcd33b01f98168799ff;hb=HEAD">QtSingleApplication</A>         <SPAN CLASS = "Italic">// The <A HREF = "http://qt.gitorious.org/qt-solutions/">QtSingleApplication</A> library</SPAN>
<A HREF = "http://opencor.git.sourceforge.net/git/gitweb.cgi?p=opencor/opencor;a=tree;f=build;h=0fdd52995b5301ea8e028222ae7d7e7578a9f8e8;hb=HEAD">build</A>                       <SPAN CLASS = "Italic">// Where OpenCOR-related build files are generated</SPAN>
<A HREF = "http://opencor.git.sourceforge.net/git/gitweb.cgi?p=opencor/opencor;a=tree;f=distrib;h=6939b7b39925c1717ace7377ca51ba9e88628465;hb=HEAD">distrib</A>                     <SPAN CLASS = "Italic">// Various files used for the packaging of OpenCOR</SPAN>
<A HREF = "http://opencor.git.sourceforge.net/git/gitweb.cgi?p=opencor/opencor;a=tree;f=doc;h=6c3c00380180376c7a4c15381ae0f311849ac336;hb=HEAD">doc</A>                         <SPAN CLASS = "Italic">// User and developer documentation</SPAN>
    <A HREF = "http://opencor.git.sourceforge.net/git/gitweb.cgi?p=opencor/opencor;a=tree;f=doc/developer;h=383f7becc5d4021b3469e2dfffd6b9bfefe79a4a;hb=HEAD">developer</A>                   <SPAN CLASS = "Italic">// Developer-specific documentation</SPAN>
    <A HREF = "http://opencor.git.sourceforge.net/git/gitweb.cgi?p=opencor/opencor;a=tree;f=doc/res;h=6225d01d21bea1de8b179352f8eebaa6e046e44d;hb=HEAD">res</A>                         <SPAN CLASS = "Italic">// Various resource files used by the documentation</SPAN>
    <A HREF = "http://opencor.git.sourceforge.net/git/gitweb.cgi?p=opencor/opencor;a=tree;f=doc/user;h=0597b48bf4f00404dae949f046d94b61bcc4cf59;hb=HEAD">user</A>                        <SPAN CLASS = "Italic">// User-specific documentation</SPAN>
<A HREF = "http://opencor.git.sourceforge.net/git/gitweb.cgi?p=opencor/opencor;a=tree;f=i18n;h=8ae5ae5e7112a5cf897e8c5de02e31aed149e1e2;hb=HEAD">i18n</A>                        <SPAN CLASS = "Italic">// Internationalisation files</SPAN>
<A HREF = "http://opencor.git.sourceforge.net/git/gitweb.cgi?p=opencor/opencor;a=tree;f=res;h=6f33dddce45ab69ecaee35bfdc6f9fb919d6d47a;hb=HEAD">res</A>                         <SPAN CLASS = "Italic">// Various resource files used by OpenCOR</SPAN>
<A HREF = "http://opencor.git.sourceforge.net/git/gitweb.cgi?p=opencor/opencor;a=tree;f=src;h=b11ecf33d667b70914086e8a27d3a815b82d2160;hb=HEAD">src</A>                         <SPAN CLASS = "Italic">// Source code files for OpenCOR</SPAN>
    <A HREF = "http://opencor.git.sourceforge.net/git/gitweb.cgi?p=opencor/opencor;a=tree;f=src/misc;h=f5c036aa2a99598514972851515fbc2184feab75;hb=HEAD">misc</A>                        <SPAN CLASS = "Italic">// Files that do not fit anywhere else</SPAN>
    <A HREF = "http://opencor.git.sourceforge.net/git/gitweb.cgi?p=opencor/opencor;a=tree;f=src/ui;h=cf183e6a61b477da60b6e4b9b664945ad781b136;hb=HEAD">ui</A>                          <SPAN CLASS = "Italic">// User interface files</SPAN>
    <A HREF = "http://opencor.git.sourceforge.net/git/gitweb.cgi?p=opencor/opencor;a=tree;f=src/widget;h=a4f7d1765e32d7cd6b6627e61a280ae8d77dab2a;hb=HEAD">widget</A>                      <SPAN CLASS = "Italic">// Widget files</SPAN>
<A HREF = "http://opencor.git.sourceforge.net/git/gitweb.cgi?p=opencor/opencor;a=tree;f=winConsole;h=08d7aab5d4b92c86f12915d10ce3e8acf76b0884;hb=HEAD">winConsole</A>                  <SPAN CLASS = "Italic">// Console version of OpenCOR (Windows only)</SPAN>
    <A HREF = "http://opencor.git.sourceforge.net/git/gitweb.cgi?p=opencor/opencor;a=tree;f=winConsole/build;h=0fdd52995b5301ea8e028222ae7d7e7578a9f8e8;hb=HEAD">build</A>                       <SPAN CLASS = "Italic">// Where the build files are generated</SPAN>
    <A HREF = "http://opencor.git.sourceforge.net/git/gitweb.cgi?p=opencor/opencor;a=tree;f=winConsole/res;h=af95d134c5f4f9fa51c288e6ccd403af7bec26dd;hb=HEAD">res</A>                         <SPAN CLASS = "Italic">// Various resource files</SPAN>
    <A HREF = "http://opencor.git.sourceforge.net/git/gitweb.cgi?p=opencor/opencor;a=tree;f=winConsole/src;h=852d65ea490074d35a51981f2d96c5d3f7a51d6d;hb=HEAD">src</A>                         <SPAN CLASS = "Italic">// Source code files</SPAN></PRE>
        </P>

        <P>
            <SPAN CLASS = "SectionFont">Coding Style</SPAN>
        </P>

        <P>
            No matter how great an application is, if its source code is difficult to understand and/or to maintain, it will have a limited life expectancy. This document therefore provides some simple rules which, as much as possible, ought to be respected when working on OpenCOR. These rules were taken (paraphrased, if not simply copied/pasted) from the <A HREF = "http://qt.gitorious.org/qt-creator/qt-creator/blobs/master/doc/api/coding-style.qdoc">coding style document</A> written by the developers of <A HREF = "http://qt.nokia.com/products/developer-tools">Qt Creator</A>:
        </P>

        <UL>
            <LI>
                <SPAN CLASS = "Bold">General</SPAN>
                    <UL>
                        <LI>The most important rule first: the <A HREF = "http://en.wikipedia.org/wiki/KISS_principle">KISS principle</A>, i.e.  <SPAN CLASS = "Italic">keep it simple, stupid!</SPAN> Always use a simple implementation in favour of a more complicated one. This eases maintenance a lot!
                        <LI>Write good C++ code: readable, well commented when necessary, and taking advantage of the object-oriented model.</LI>
                        <LI>Adapt the code to the structures already existing in OpenCOR, or in the case that you have better ideas, discuss them with <A HREF = "../user/authors.html">other developers</A> before writing the code.</LI>
                        <LI>Take advantage of Qt. Think about what parts of your code are generic enough that they might be incorporated into Qt proper.</LI>
                        <LI>Document interfaces (using <A HREF = "http://www.stack.nl/~dimitri/doxygen/">doxygen</A>).</LI>
                    </UL>
            </LI>
            <LI>
                <SPAN CLASS = "Bold">Code constructs:</SPAN> the following guidelines exist to make the code faster, clearer, and/or to take advantage of the strong type checking in C++.
                    <UL>
                        <LI>Declaration of variables should wait as long as possible. The rule is: <SPAN CLASS = "Italic">Don't declare it until you need it.</SPAN> In C++, there are a lot of user defined types, and these can very often be expensive to initialise.</LI>
                        <LI>Make the scope of a variable as small as possible.</LI>
                        <LI>
                            Prefer pre-increment to post-increment whenever possible. Pre-increment has potential of being faster than post-increment. This rule applies to decrement too.
                                <PRE CLASS = "Good">++i;
--j;</PRE>
                                <PRE CLASS = "Bad">i++;
j--;</PRE>
                        </LI>
                        <LI>
                            Try to minimise evaluation of the same code over and over. This is aimed especially at loops:
                                <PRE CLASS = "Good">Container::iterator end = large.end();

for (Container::iterator iter = large.begin(); iter != end; ++iter) {
    ...
}</PRE>
                                <PRE CLASS = "Bad">for (Container::iterator iter = large.begin(); iter != large.end(); ++iter) {
    ...
}</PRE>
                        </LI>
                        <LI>
                            You can use the Qt <CODE>foreach</CODE> loop in non-time-critical code with a Qt
            container. It is a nice way to keep line noise down and to give the loop variable a proper name:
                                <PRE CLASS = "Good">foreach (QWidget *widget, container)
    doSomething(widget);</PRE>
                                <PRE CLASS = "Bad">Container::iterator end = container.end();

for (Container::iterator iter = container.begin(); iter != end; ++iter)
    doSomething(*iter);</PRE>
                            Make the loop variable <CODE>const</CODE>, if possible. This might prevent unnecessary detaching of shared data.
                                <PRE CLASS = "Good">foreach (const QString &name, someListOfNames)
    doSomething(name);</PRE>
                                <PRE CLASS = "Bad">foreach (QString name, someListOfNames)
    doSomething(name);</PRE>
                        </LI>
                    </UL>
            </LI>
            <LI>
                <SPAN CLASS = "Bold">Formatting</SPAN>
                    <UL>
                        <LI>Indentation: 4 spaces, no tabulations.</LI>
                        <LI>
                            Naming rules:
                                <UL>
                                    <LI>Use descriptive, simple and short names.</LI>
                                    <LI>
                                        Single character variable names are only okay for counters and temporaries where the purpose of the variable is obvious.
                                            <PRE CLASS = "Good">int width;
int height;
char *nameOfThis;
char *nameOfThat;</PRE>
                                            <PRE CLASS = "Bad">int a, b;
char *c, *d;</PRE>
                                    </LI>
                                    <LI>
                                        Class names and enums start with an upper-case letter while variables and functions start with a lower-case letter. Each consecutive word in a name starts with an upper-case letter.
                                            <PRE CLASS = "Good">class MainWindow : public QMainWindow
{
    ...
    int mMyVariable;
    ...
    void myFunction();
    ...
}</PRE>
                                            <PRE CLASS = "Bad">class mainWindow : public QMainWindow
{
    ...
    int Myvariable;
    ...
    void My_function();
    ...
}</PRE>
                                        <SPAN CLASS = "Bold">Note:</SPAN> class variables start with a lower-case <CODE>m</CODE>.
                                    </LI>
                                    <LI>
                                        Parameters passed to a function start with a lower-case <CODE>p</CODE>, but not local variables.
                                            <PRE CLASS = "Good">int main(int pArgc, char *pArgv[])
{
    int someVariable;
    ...
}</PRE>
                                            <PRE CLASS = "Bad">int main(int argc, char *argv[])
{
    int pSomeVariable;
    ...
}</PRE>
                                    </LI>
                                </UL>
                        </LI>
                        <LI>
                            Declarations: use only one declaration per line and wait with declaring a variable until it is needed.
                                <PRE CLASS = "Good">int a;
int b;</PRE>
                                <PRE CLASS = "Bad">int a, b;</PRE>
                            This is especially important when initialisation is done at the same time.
                                <PRE CLASS = "Good">QString a = "Joe";
QString b = "Foo";</PRE>
                                <PRE CLASS = "Bad">QString a = "Joe", b = "Foo";</PRE>
                            <SPAN CLASS = "Bold">Note:</SPAN> <CODE>QString a = "Joe";</CODE> is formally calling a copy constructor on a temporary string constructed from a string literal and therefore has the potential of being more expensive than direct construction by <CODE>QString a("joe")</CODE>. However, the compiler is allowed to elide the copy (even if it had side effects), and modern compilers typically do so. Given these equal costs, OpenCOR code favours the <CODE>=</CODE> idiom as it is in line with the traditional C-style initialisation, <SPAN CLASS = "Italic">and</SPAN> cannot be mistaken as a function declaration, <SPAN CLASS = "Italic">and</SPAN> reduces the level of nested parantheses in more initialisations.
                        </LI>
                        <LI>
                            Pointers and references
                                <PRE CLASS = "Good">char *p = "flop";
char &c = *p;</PRE>
                                <PRE CLASS = "Bad">char* p = "flop";
char & c = *p;</PRE>
                            Also, we will have:
                                <PRE CLASS = "Good">const char *p;</PRE>
                                <PRE CLASS = "Bad">char const * p;</PRE>
                            Using a plain <CODE>0</CODE> for <CODE>NULL</CODE> pointer constants is always correct and least effort to type. So:
                                <PRE CLASS = "Good">void *p = 0;</PRE>
                                <PRE CLASS = "Bad">void *p = NULL;
void *p = '\0';
void *p = 42-7*6;</PRE>
                            <SPAN CLASS = "Bold">Note:</SPAN> as an exception, imported third-party code, as well as code interfacing with the <SPAN CLASS = "Italic">native</SPAN> APIs (<CODE>src/support/os_*</CODE>), can use <CODE>NULL</CODE>.
                        </LI>
                        <LI>
                            Whitespace:
                            <UL>
                                <LI>Use blank lines to group statements together where suited.</LI>
                                <LI>Always use only one blank line.</LI>
                                <LI>
                                    Operator names and parentheses: do not use spaces between operator names and function names. The <CODE>==</CODE> is part of the function name, and therefore, spaces make the declaration look like an expression:
                                        <PRE CLASS = "Good">operator==(type)</PRE>
                                        <PRE CLASS = "Bad">operator == (type)</PRE>
                                </LI>
                                <LI>
                                    Function names and parentheses: do not use spaces between function names and parentheses:
                                        <PRE CLASS = "Good">void mangle()</PRE>
                                        <PRE CLASS = "Bad">void mangle ()</PRE>
                                </LI>
                                <LI>
                                    Always use a single space after a keyword, and before a curly brace.
                                        <PRE CLASS = "Good">if (foo) {
}</PRE>
                                        <PRE CLASS = "Bad">if(foo){
}</PRE>
                                </LI>
                                <LI>For pointers or references, always use a single space before <CODE>*</CODE> or <CODE>&</CODE>, but never after.</LI>
                                <LI>
                                    Avoid C-style casts when possible:
                                        <PRE CLASS = "Good">char *blockOfMemory = (char *)malloc(data.size());
char *blockOfMemory = reinterpret_cast<char *>(malloc(data.size()));</PRE>
                                        <PRE CLASS = "Bad">char* blockOfMemory = (char* ) malloc(data.size());</PRE>
                                    Of course, in this particulare case, using <CODE>new</CODE> might be an even better option.
                                </LI>
                            </UL>
                        </LI>
                        <LI>
                            Braces:
                                <UL>
                                    <LI>
                                        As a base rule, place the left curly brace on the same line as the start of the statement:
                                            <PRE CLASS = "Good">if (codec) {
}</PRE>
                                            <PRE CLASS = "Bad">if (codec)
{
}</PRE>
                                        <SPAN CLASS = "Bold">Exception:</SPAN> function implementations and class declarations always have the left brace in the beginning of a line:
                                            <PRE CLASS = "Good">static void foo(int g)
{
    qDebug("foo: %i", g);
}</PRE>
                                            <PRE CLASS = "Bad">static void foo(int g) {
    qDebug("foo: %i", g);
}</PRE>
                                            <PRE CLASS = "Good">class Moo
{
};</PRE>
                                <PRE CLASS = "Bad">class Moo {
};</PRE>
                                    </LI>
                                    <LI>
                                        Use curly braces when the body of a conditional statement contains more than one line, and also if a single line statement is somewhat complex. Otherwise, omit them:
                                            <PRE CLASS = "Good">if (address.isEmpty())
    return false;</PRE>
                                            <PRE CLASS = "Bad">if (address.isEmpty()) {
    return false;
}</PRE>
                                            <PRE CLASS = "Good">for (int i = 0; i < 10; ++i)
    qDebug("%i", i);</PRE>
                                            <PRE CLASS = "Bad">for (int i = 0; i < 10; ++i) {
    qDebug("%i", i);
}</PRE>
                                        <SPAN CLASS = "Bold">Exception #1:</SPAN> use braces also if the parent statement covers several lines or if it wraps:
                                            <PRE>if (   address.isEmpty()
    || !isValid()
    || !codec)
    return false;</PRE>
                                        <SPAN CLASS = "Bold">Note:</SPAN> this could be re-written as:
                                            <PRE CLASS = "Good">if (address.isEmpty())
    return false;

if (!isValid())
    return false;

if (!codec)
    return false;</PRE>
                                        <SPAN CLASS = "Bold">Exception #2:</SPAN> use braces also in <CODE>if-then-else</CODE> blocks where either the <CODE>if</CODE> code or the <CODE>else</CODE> code covers several lines:
                                            <PRE CLASS = "Good">if (address.isEmpty()) {
    --it;
} else {
    qDebug("%s", qPrintable(address));
    ++it;
}</PRE>
                                            <PRE CLASS = "Bad">if (address.isEmpty())
    --it;
else {
    qDebug("%s", qPrintable(address));
    ++it;
}</PRE>
                                            <PRE CLASS = "Good">if (a) {
    if (b)
        ...
    else
        ...
}</PRE>
                                            <PRE CLASS = "Bad">if (a)
    if (b)
        ...
    else
        ...</PRE>
                                    </LI>
                                    <LI>
                                        Use curly braces when the body of a conditional statement is empty:
                                            <PRE CLASS = "Good">while (a) {}</PRE>
                                            <PRE CLASS = "Bad">while (a);</PRE>
                                    </LI>
                                </UL>
                        </LI>
                        <LI>
                            Parentheses: use parentheses to group expressions:
                                <PRE CLASS = "Good">if ((a && b) || c)</PRE>
                                <PRE CLASS = "Bad">if (a && b || c)</PRE>
                                <PRE CLASS = "Good">(a + b) & c</PRE>
                                <PRE CLASS = "Bad">a + b & c</PRE>
                        </LI>
                        <LI>
                            Line Breaks:
                                <UL>
                                    <LI>Keep lines shorter than 100 characters.</LI>
                                    <LI>Insert line breaks if necessary.</LI>
                                    <LI>Commas go at the end of a broken line.</LI>
                                    <LI>
                                        Operators start at the beginning of the new line.
                                            <PRE CLASS = "Good">if (   longExpression
    || otherLongExpression
    || otherOtherLongExpression) {
}</PRE>
                                            <PRE CLASS = "Bad">if (longExpression ||
    otherLongExpression ||
    otherOtherLongExpression) {
}</PRE>
                                    </LI>
                                </UL>
                        </LI>
                        <LI>
                            Declarations:
                                <UL>
                                    <LI>Use this order for the access sections of your class: <CODE>public</CODE>, <CODE>protected</CODE> and <CODE>private</CODE>. The <CODE>public</CODE> section is interesting for every user of the class. The <CODE>private</CODE> section is only of interest for the implementors of the class (you).</LI>
                                    <LI>Avoid declaring global objects in the declaration file of the class. If the same variable is used for all objects, use a <CODE>static</CODE> member.</LI>
                                </UL>
                        </LI>
                    </UL>
            </LI>
            <LI>
                <SPAN CLASS = "Bold">Miscellaneous</SPAN>
                    <UL>
                        <LI>Put the body of a function in a <CODE>.cpp</CODE> file, not in its header file. There is both a <CODE>.cpp</CODE> file and a <CODE>.h</CODE> file for a reason.</LI>
                        <LI>Do not use inline functions. It is better to rely on the compiler to optimise the code, not to mention that, if badly used, inline functions can result in slower code.</LI>
                        <LI>
                            Replace divisions by multiplications if possible:
                                <PRE CLASS = "Good">a = 0.5*b;</PRE>
                                <PRE CLASS = "Bad">a = b/2;</PRE>
                        </LI>
                    </UL>
            </LI>
        </UL>

        <P CLASS = "CopyrightBackground">
            <SPAN CLASS = "CopyrightFont">Copyright ©2011</SPAN>
        </P>
    </BODY>
</HTML>
