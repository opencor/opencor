<!DOCTYPE html>
<html>
    <head>
        <title>
            SampleView Plugin
        </title>

        <meta http-equiv="content-type" content="text/html; charset=utf-8"/>

        <link href="../../../3rdparty/googleCodePrettify/prettify.css" rel="stylesheet" type="text/css"/>
        <link href="../../res/stylesheet.css" rel="stylesheet" type="text/css"/>

        <script src="../../../3rdparty/googleCodePrettify/prettify.js" type="text/javascript"></script>
        <script src="../../../3rdparty/jQuery/jquery.js" type="text/javascript"></script>
        <script src="../../../res/common.js" type="text/javascript"></script>
        <script src="../../res/menu.js" type="text/javascript"></script>
    </head>
    <body onload="prettyPrint()">
        <script type="text/javascript">
            headerAndContentsMenu("SampleView Plugin", "../../..");
        </script>

        <p>
            The purpose of this plugin is to provide a view that gives some information about the current file.
        </p>

        <div class="section">
            File structure
        </div>

        <pre><a href="https://github.com/opencor/opencor/tree/master/src/plugins/sample/SampleView/i18n">i18n</a>
 &#9492;&#9472; <a href="https://github.com/opencor/opencor/tree/master/src/plugins/sample/SampleView/i18n/SampleView_fr.ts">SampleView_fr.ts</a>
<a href="https://github.com/opencor/opencor/tree/master/src/plugins/sample/SampleView/res">res</a>
 &#9492;&#9472; <a href="https://github.com/opencor/opencor/tree/master/src/plugins/sample/SampleView/res/SampleView.qrc">SampleView.qrc</a>
<a href="https://github.com/opencor/opencor/tree/master/src/plugins/sample/SampleView/src">src</a>
 &#9500;&#9472; <a href="https://github.com/opencor/opencor/tree/master/src/plugins/sample/SampleView/src/sampleviewplugin.cpp">sampleviewplugin.cpp</a>
 &#9500;&#9472; <a href="https://github.com/opencor/opencor/tree/master/src/plugins/sample/SampleView/src/sampleviewplugin.h">sampleviewplugin.h</a>
 &#9500;&#9472; <a href="https://github.com/opencor/opencor/tree/master/src/plugins/sample/SampleView/src/sampleviewplugin.json">sampleviewplugin.json</a>
 &#9500;&#9472; <a href="https://github.com/opencor/opencor/tree/master/src/plugins/sample/SampleView/src/sampleviewwidget.cpp">sampleviewwidget.cpp</a>
 &#9500;&#9472; <a href="https://github.com/opencor/opencor/tree/master/src/plugins/sample/SampleView/src/sampleviewwidget.h">sampleviewwidget.h</a>
 &#9492;&#9472; <a href="https://github.com/opencor/opencor/tree/master/src/plugins/sample/SampleView/src/sampleviewwidget.ui">sampleviewwidget.ui</a>
<a href="https://github.com/opencor/opencor/tree/master/src/plugins/sample/SampleView/CMakeLists.txt">CMakeLists.txt</a></pre>

        <div class="section">
            Category
        </div>

        <p>
            Our plugin is part of the <code>Sample</code> category, which means that its code can be found under <a href="https://github.com/opencor/opencor/blob/master/src/plugins/sample/SampleView/"><code>[OpenCOR]/src/plugins/sample/SampleView/</code></a>.
        </p>

        <div class="section">
            Interfaces
        </div>

        <p>
            We want our plugin to interact with OpenCOR. This means that it needs to implement some interfaces (click <a href="index.html#Interfaces">here</a> for some information on interfaces).
        </p>

        <p>
            More specifically, we want our plugin to be a view, so we need to implement both the <a href="https://github.com/opencor/opencor/blob/master/src/plugins/filehandlinginterface.inl">file handling</a>, <a href="https://github.com/opencor/opencor/blob/master/src/plugins/plugininterface.inl">plugin</a> and <a href="https://github.com/opencor/opencor/blob/master/src/plugins/viewinterface.inl">view</a> interfaces. While we are at it, we might as well internationalise our plugin, in which case it means that we also need to implement the <a href="https://github.com/opencor/opencor/blob/master/src/plugins/i18ninterface.inl">internationalisation</a> interface.
        </p>

        <div class="section">
            CMake project
        </div>

        <p>
            As for any OpenCOR plugin, our plugin has a <a href="https://github.com/opencor/opencor/blob/master/src/plugins/sample/SampleView/CMakeLists.txt"><code>CMakeLists.txt</code></a> file, which contents is:
        </p>

        <pre class="prettyprint linenums">PROJECT(SampleViewPlugin)

# Add the plugin

ADD_PLUGIN(SampleView
    SOURCES
        <a href="https://github.com/opencor/opencor/blob/master/src/plugins/i18ninterface.cpp"><code>../../i18ninterface.cpp</code></a>
        <a href="https://github.com/opencor/opencor/blob/master/src/plugins/plugininfo.cpp"><code>../../plugininfo.cpp</code></a>
        <a href="https://github.com/opencor/opencor/blob/master/src/plugins/viewinterface.cpp"><code>../../viewinterface.cpp</code></a>

        <a href="https://github.com/opencor/opencor/blob/master/src/plugins/sample/SampleView/src/sampleviewplugin.cpp"><code>src/sampleviewplugin.cpp</code></a>
        <a href="https://github.com/opencor/opencor/blob/master/src/plugins/sample/SampleView/src/sampleviewwidget.cpp"><code>src/sampleviewwidget.cpp</code></a>
    HEADERS_MOC
        <a href="https://github.com/opencor/opencor/blob/master/src/plugins/sample/SampleView/src/sampleviewplugin.h"><code>src/sampleviewplugin.h</code></a>
        <a href="https://github.com/opencor/opencor/blob/master/src/plugins/sample/SampleView/src/sampleviewwidget.h"><code>src/sampleviewwidget.h</code></a>
    UIS
        <a href="https://github.com/opencor/opencor/blob/master/src/plugins/sample/SampleView/src/sampleviewwidget.ui"><code>src/sampleviewwidget.ui</code></a>
    INCLUDE_DIRS
        src
    PLUGINS
        Core
    QT_MODULES
        Widgets
        XmlPatterns
    QT_LIBRARIES
        QtCore
        QtGui
        QtNetwork
        QtWidgets
        QtXmlPatterns
)</pre>

        <p>
            Some of the interfaces our plugin implements come with a <code>.cpp</code> file, so we reference them (lines 7 and 9). Then, our plugin needs the <strong>Core</strong> plugin, so it is referenced (line 21) using the <code>PLUGINS</code> keyword (line 20). Our plugin provides OpenCOR with a test view, which is implemented using various files (lines 12, 15 and 17). One of those files is a <code>.ui</code> file, which is referenced using the <code>UIS</code> keyword (line 16). Finally, we reference the <a href="http://www.qt.io/">Qt</a> modules (line 23-24) and libraries (lines 26-30) needed by our plugin.
        </p>

        <div class="section">
            Plugin information
        </div>

        <p>
            Our <a href="index.html#Plugin%20information">plugin information</a> can be found in <a href="https://github.com/opencor/opencor/blob/master/src/plugins/sample/SampleView/src/sampleviewplugin.cpp"><code>sampleviewplugin.cpp</code></a>, <a href="https://github.com/opencor/opencor/blob/master/src/plugins/sample/SampleView/src/sampleviewplugin.h"><code>sampleviewplugin.h</code></a> and <a href="https://github.com/opencor/opencor/blob/master/src/plugins/sample/SampleView/src/sampleviewplugin.json"><code>sampleviewplugin.json</code></a>. Starting with <a href="https://github.com/opencor/opencor/blob/master/src/plugins/sample/SampleView/src/sampleviewplugin.h"><code>sampleviewplugin.h</code></a>, its contents is:
        </p>

        <pre class="prettyprint linenums:22">#ifndef SAMPLEVIEWPLUGIN_H
#define SAMPLEVIEWPLUGIN_H

//==============================================================================

#include "<a href="https://github.com/opencor/opencor/blob/master/src/plugins/filehandlinginterface.h"><code>filehandlinginterface.h</code></a>"
#include "<a href="https://github.com/opencor/opencor/blob/master/src/plugins/i18ninterface.h"><code>i18ninterface.h</code></a>"
#include "<a href="https://github.com/opencor/opencor/blob/master/src/plugins/plugininfo.h"><code>plugininfo.h</code></a>"
#include "<a href="https://github.com/opencor/opencor/blob/master/src/plugins/plugininterface.h"><code>plugininterface.h</code></a>"
#include "<a href="https://github.com/opencor/opencor/blob/master/src/plugins/viewinterface.h"><code>viewinterface.h</code></a>"

//==============================================================================

namespace OpenCOR {
namespace SampleView {

//==============================================================================

PLUGININFO_FUNC SampleViewPluginInfo();

//==============================================================================

class SampleViewWidget;

//==============================================================================

class SampleViewPlugin : public QObject, public FileHandlingInterface,
                         public I18nInterface, public PluginInterface,
                         public ViewInterface
{
    Q_OBJECT

    Q_PLUGIN_METADATA(IID "OpenCOR.SampleViewPlugin" FILE "<a href="https://github.com/opencor/opencor/blob/master/src/plugins/sample/SampleView/src/sampleviewplugin.json"><code>sampleviewplugin.json</code></a>")

    Q_INTERFACES(OpenCOR::FileHandlingInterface)
    Q_INTERFACES(OpenCOR::I18nInterface)
    Q_INTERFACES(OpenCOR::PluginInterface)
    Q_INTERFACES(OpenCOR::ViewInterface)

public:
    explicit SampleViewPlugin();

#include "<a href="https://github.com/opencor/opencor/blob/master/src/plugins/filehandlinginterface.inl"><code>filehandlinginterface.inl</code></a>"
#include "<a href="https://github.com/opencor/opencor/blob/master/src/plugins/i18ninterface.inl"><code>i18ninterface.inl</code></a>"
#include "<a href="https://github.com/opencor/opencor/blob/master/src/plugins/plugininterface.inl"><code>plugininterface.inl</code></a>"
#include "<a href="https://github.com/opencor/opencor/blob/master/src/plugins/viewinterface.inl"><code>viewinterface.inl</code></a>"

private:
    SampleViewWidget *mViewWidget;

    QString mFileName;
};

//==============================================================================

}   // namespace SampleView
}   // namespace OpenCOR

//==============================================================================

#endif</pre>

        <p>
            As mentioned above, our plugin implements some interfaces, which means that their header file is included (lines 27-28 and 30-31). It also means that our plugin class inherits from those interfaces (lines 48-50), as well as make calls to the <code>Q_INTERFACES()</code> macro to let <a href="http://www.qt.io/">Qt</a> know which interfaces it implements (lines 56-59). Finally, we include the inline files (lines 64-67) that declare various methods that must be implemented by our plugin (see the <a href="#Interfaces%20implementation">next section</a>). (The rest of the class definition is specific to our plugin and is discussed <a href="#Plugin%20specific">below</a>.)
        </p>

        <p>
            The C function that is used by OpenCOR to retrieve some <a href="index.html#Basic%20information">basic information</a> about our plugin can be found in <a href="https://github.com/opencor/opencor/blob/master/src/plugins/sample/SampleView/src/sampleviewplugin.cpp"><code>sampleviewplugin.cpp</code></a>:
        </p>

        <pre class="prettyprint linenums:40">PLUGININFO_FUNC SampleViewPluginInfo()
{
    Descriptions descriptions;

    descriptions.insert("en", QString::fromUtf8("a plugin that provides a test view."));
    descriptions.insert("fr", QString::fromUtf8("une extension qui fournit une vue de test."));

    return new PluginInfo(PluginInfo::Sample, true, false,
                          QStringList() << "Core",
                          descriptions);
}</pre>

        <p>
            As can be seen, our plugin is selectable by the user, but it does not offer direct <a href="http://en.wikipedia.org/wiki/Command-line_interface">CLI</a> support (line 47). It also has a direct dependency on the <strong>Core</strong> plugin (line 48).
        </p>

        <span class="anchor" id="Interfaces implementation"></span>

        <div class="section">
            Interfaces implementation
        </div>

        <p>
            The implementation of the interfaces' various methods can also be found in <a href="https://github.com/opencor/opencor/blob/master/src/plugins/sample/SampleView/src/sampleviewplugin.cpp"><code>sampleviewplugin.cpp</code></a>. The methods are grouped by interface and are ordered alphabetically. The interfaces are also ordered alphabetically, making it easier to read and maintain the code.
        </p>

        <p>
            We start with the <a href="https://github.com/opencor/opencor/blob/master/src/plugins/filehandlinginterface.inl">file handling</a> interface:
        </p>

        <pre class="prettyprint linenums:59">//==============================================================================
// File handling interface
//==============================================================================

bool SampleViewPlugin::saveFile(const QString &pOldFileName,
                                const QString &pNewFileName)
{
    Q_UNUSED(pOldFileName);
    Q_UNUSED(pNewFileName);

    // We don't handle this interface...

    return false;
}

//==============================================================================

void SampleViewPlugin::fileOpened(const QString &pFileName)
{
    Q_UNUSED(pFileName);

    // We don't handle this interface...
}

//==============================================================================

void SampleViewPlugin::filePermissionsChanged(const QString &pFileName)
{
    // The given file has had its permissions changed, so update our view
    // widget, if needed

    if (!pFileName.compare(mFileName))
        mViewWidget->update(pFileName);
}

//==============================================================================

void SampleViewPlugin::fileModified(const QString &pFileName)
{
    Q_UNUSED(pFileName);

    // We don't handle this interface...
}

//==============================================================================

void SampleViewPlugin::fileReloaded(const QString &pFileName)
{
    // The given file has been reloaded, so update our view widget, if needed

    if (!pFileName.compare(mFileName))
        mViewWidget->update(pFileName);
}

//==============================================================================

void SampleViewPlugin::fileRenamed(const QString &pOldFileName,
                                   const QString &pNewFileName)
{
    Q_UNUSED(pOldFileName);

    // The given file has been renamed, so update our view widget, if needed

    if (!pOldFileName.compare(mFileName)) {
        mFileName = pNewFileName;

        mViewWidget->update(pNewFileName);
    }
}

//==============================================================================

void SampleViewPlugin::fileClosed(const QString &pFileName)
{
    // The given file has been closed, so update our internals, if needed

    if (!pFileName.compare(mFileName))
        mFileName = QString();
}

//==============================================================================</pre>

        <p>
            Our plugin provides a view and, as such, should at least handle some of the <a href="https://github.com/opencor/opencor/blob/master/src/plugins/filehandlinginterface.inl">file handling</a> interface's methods. Here, we want our plugin to provide some information about the current file, so we do not want to handle the <code>saveFile()</code> method (lines 63-72). Other methods that do not need to be implemented are <code>fileOpened()</code> (lines 76-81) and <code>fileModified()</code> (lines 96-101). On the other hand, should the current file have its permissions changed or be renamed, then we want to update the information presented in our view. We do this by implementing the <code>filePermissionsChanged()</code> (lines 85-92) and <code>fileReloaded()</code> (lines 105-111) methods. The same holds true if the current file gets renamed, in which case we also want to update <code>mFileName</code> (see <code>fileRenamed()</code>; lines 115-127). Finally, we want to reset <code>mFileName</code> if the current file gets closed (see <code>fileClosed()</code>; lines 131-137).
        </p>

        <p>
            Next, we have the <a href="https://github.com/opencor/opencor/blob/master/src/plugins/i18ninterface.inl">internationalisation</a> interface:
        </p>

        <pre class="prettyprint linenums:139">//==============================================================================
// I18n interface
//==============================================================================

void SampleViewPlugin::retranslateUi()
{
    // Retranslate our view widget, if needed

    if (!mFileName.isEmpty())
        mViewWidget->retranslateUi();
}

//==============================================================================</pre>

        <p>
            If some information is being shown for a file, then we ask our view to retranslate itself.
        </p>

        <p>
            After the <a href="https://github.com/opencor/opencor/blob/master/src/plugins/i18ninterface.inl">internationalisation</a> interface, we have the <a href="https://github.com/opencor/opencor/blob/master/src/plugins/plugininterface.inl">plugin</a> interface:
        </p>

        <pre class="prettyprint linenums:151">//==============================================================================
// Plugin interface
//==============================================================================

void SampleViewPlugin::initializePlugin(QMainWindow *pMainWindow)
{
    // Create our sample view widget

    mViewWidget = new SampleViewWidget(pMainWindow);

    // Hide our sample view widget since it may not initially be shown in our
    // central widget

    mViewWidget->setVisible(false);
}

//==============================================================================

void SampleViewPlugin::finalizePlugin()
{
    // We don't handle this interface...
}

//==============================================================================

void SampleViewPlugin::pluginsInitialized(const Plugins &pLoadedPlugins)
{
    Q_UNUSED(pLoadedPlugins);

    // We don't handle this interface...
}

//==============================================================================

void SampleViewPlugin::loadSettings(QSettings *pSettings)
{
    Q_UNUSED(pSettings);

    // We don't handle this interface...
}

//==============================================================================

void SampleViewPlugin::saveSettings(QSettings *pSettings) const
{
    Q_UNUSED(pSettings);

    // We don't handle this interface...
}

//==============================================================================

void SampleViewPlugin::handleAction(const QUrl &pUrl)
{
    Q_UNUSED(pUrl);

    // We don't handle this interface...
}

//==============================================================================</pre>

        <p>
            The only method of interest to our plugin is <code>initializePlugin()</code> (lines 155-165), which is where we initialise <code>mViewWidget</code>, our view. All the other methods (<code>finalizePlugin()</code>, <code>pluginsInitialized()</code>, <code>loadSettings()</code>, <code>saveSettings()</code> and <code>handleAction()</code>) are left empty.
        </p>

        <p>
            Finally, we have the <a href="https://github.com/opencor/opencor/blob/master/src/plugins/viewinterface.inl">view</a> interface:
        </p>

        <pre class="prettyprint linenums:210">//==============================================================================
// View interface
//==============================================================================

ViewInterface::Mode SampleViewPlugin::viewMode() const
{
    // Return our mode

    return ViewInterface::Sample;
}

//==============================================================================

QStringList SampleViewPlugin::viewMimeTypes() const
{
    // Return the MIME types we support, i.e. any in our case

    return QStringList();
}

//==============================================================================

QWidget * SampleViewPlugin::viewWidget(const QString &pFileName)
{
    // Update and return our sample view widget using the given file

    mFileName = pFileName;

    mViewWidget->update(pFileName);

    return mViewWidget;
}

//==============================================================================

void SampleViewPlugin::removeViewWidget(const QString &pFileName)
{
    Q_UNUSED(pFileName);

    // Reset our internals

    mFileName = QString();
}

//==============================================================================

QString SampleViewPlugin::viewName() const
{
    // Return our sample view's name

    return tr("Sample");
}

//==============================================================================

QIcon SampleViewPlugin::fileTabIcon(const QString &pFileName) const
{
    Q_UNUSED(pFileName);

    // We don't handle this interface...

    return QIcon();
}

//==============================================================================</pre>

        <p>
            Our plugin provides a view, so OpenCOR needs to know about its name (see <code>viewName()</code>; lines 256-261), its type (see <code>viewMode()</code>; lines 214-219), the MIME types it supports (see <code>viewMimeTypes()</code>; lines 223-228) and whether it needs a special tab icon (see <code>fileTabIcon()</code>; lines 265-272). OpenCOR also needs to know the widget that is used for the view and this for a given file (see <code>viewWidget()</code>; lines 232-241). Note that our plugin uses only one view widget (and updates its contents based on the file that is currently active), but it might perfectly use one per file. Finally, our plugin needs to handle the case where a view widget is to be removed (see <code>removeViewWidget()</code>; lines 245-252), which happens whenever a file gets closed.
        </p>

        <span class="anchor" id="Plugin specific"></span>

        <div class="section">
            Plugin specific
        </div>

        <p>
            Some extra work is needed to get our plugin to do what it is supposed to be doing, and this is done via the <code>SampleViewWidget</code> class in <a href="https://github.com/opencor/opencor/blob/master/src/plugins/sample/SampleView/src/sampleviewwidget.h"><code>sampleviewwidget.h</code></a>:
        </p>

        <pre class="prettyprint linenums:22">#ifndef SAMPLEVIEWWIDGET_H
#define SAMPLEVIEWWIDGET_H

//==============================================================================

#include "viewwidget.h"

//==============================================================================

namespace Ui {
    class SampleViewWidget;
}

//==============================================================================

namespace OpenCOR {
namespace SampleView {

//==============================================================================

class SampleViewWidget : public Core::ViewWidget
{
    Q_OBJECT

public:
    explicit SampleViewWidget(QWidget *pParent);
    ~SampleViewWidget();

    virtual void retranslateUi();

    void update(const QString &pFileName);

private:
    Ui::SampleViewWidget *mGui;

    QString mFileName;
};

//==============================================================================

}   // namespace SampleView
}   // namespace OpenCOR

//==============================================================================

#endif</pre>

        <p>
            <code>SampleViewWidget</code> inherits from <code>Core::ViewWidget</code>, which is defined in the <strong>Core</strong> plugin and is an extended version of <a href="http://www.qt.io/">Qt</a>'s <code>QWidget</code> (line 42). It also comes with a GUI file, which describes the layout of our plugin window (<a href="https://github.com/opencor/opencor/blob/master/src/plugins/sample/SampleView/src/sampleviewwidget.ui"><code>sampleviewwidget.ui</code></a>). The <code>update()</code> method is used by our plugin to update the contents of our view using information about the given file (line 52).
        </p>

        <p>
            The implementation of <code>SampleViewWidget</code> can be found in <a href="https://github.com/opencor/opencor/blob/master/src/plugins/sample/SampleView/src/sampleviewwidget.cpp"><code>sampleviewwidget.cpp</code></a>:
        </p>

        <pre class="prettyprint linenums:18">//==============================================================================
// Sample view widget
//==============================================================================

#include "corecliutils.h"
#include "filemanager.h"
#include "sampleviewwidget.h"

//==============================================================================

#include "ui_sampleviewwidget.h"

//==============================================================================

#include <QFile>

//==============================================================================

namespace OpenCOR {
namespace SampleView {

//==============================================================================

SampleViewWidget::SampleViewWidget(QWidget *pParent) :
    ViewWidget(pParent),
    mGui(new Ui::SampleViewWidget),
    mFileName(QString())
{
    // Set up the GUI

    mGui->setupUi(this);
}

//==============================================================================

SampleViewWidget::~SampleViewWidget()
{
    // Delete the GUI

    delete mGui;
}

//==============================================================================

void SampleViewWidget::retranslateUi()
{
    // Retranslate our GUI

    mGui->retranslateUi(this);

    // Update ourself too since some widgets will have been reset following the
    // retranslation (e.g. mGui->fileNameValue)

    update(mFileName);
}

//==============================================================================

void SampleViewWidget::update(const QString &pFileName)
{
    // Keep track of the given file name

    mFileName = pFileName;

    // Initialise our GUI with some information about the given file

    mGui->fileNameValue->setText(pFileName);

    Core::FileManager *fileManagerInstance = Core::FileManager::instance();

    mGui->lockedValue->setText(fileManagerInstance->isLocked(pFileName)?tr("Yes"):tr("No"));

    QString sha1Value = fileManagerInstance->sha1(pFileName);

    mGui->sha1Value->setText(sha1Value.isEmpty()?"???":sha1Value);
    mGui->sizeValue->setText(Core::sizeAsString(QFile(pFileName).size()));
}

//==============================================================================

}   // namespace SampleView
}   // namespace OpenCOR</pre>

        <p>
            <code>retranslateUi()</code> (lines 62-72) retranslates our view, as well as update its contents using <code>update()</code> (lines 76-94).
        </p>

        <script type="text/javascript">
            copyright("../../..");
        </script>
    </body>
</html>
